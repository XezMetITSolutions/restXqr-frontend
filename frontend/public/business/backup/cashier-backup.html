<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasa Paneli</title>
    <link rel="stylesheet" href="../../styles.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #4caf50;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        .container {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            background-color: #e0e0e0;
            cursor: pointer;
        }
        .filter-btn.active {
            background-color: #4caf50;
            color: white;
        }
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem;
        }
        .card.priority {
            border-left: 4px solid #ff9800;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .table-number {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .order-time {
            font-size: 0.9rem;
            color: #757575;
        }
        .order-time.urgent {
            color: #ff9800;
            font-weight: bold;
        }
        .order-items {
            margin: 1rem 0;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .item-name {
            flex: 1;
        }
        .item-quantity {
            margin: 0 1rem;
            font-weight: bold;
        }
        .item-price {
            font-weight: bold;
            color: #4caf50;
        }
        .item-notes {
            font-size: 0.8rem;
            color: #757575;
            margin-top: 0.25rem;
        }
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f0f0f0;
        }
        .total-amount {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4caf50;
        }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn-primary {
            background-color: #4caf50;
            color: white;
        }
        .btn-success {
            background-color: #2196f3;
            color: white;
        }
        .btn-warning {
            background-color: #ff9800;
            color: white;
        }
        .priority-badge {
            background-color: #ff9800;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            .header h1 {
                font-size: 1.2rem;
            }
            .container {
                padding: 0.5rem;
            }
            .filters {
                justify-content: center;
                gap: 0.5rem;
            }
            .filter-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            .cards-container {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            .card {
                padding: 0.8rem;
            }
            .table-number {
                font-size: 1rem;
            }
            .order-item {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
            .item-quantity {
                margin: 0;
                align-self: flex-end;
            }
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
                width: 100%;
                margin-top: 0.5rem;
            }
            .card-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Kasa Paneli</h1>
        <div>
            <button class="btn">Bildirimler</button>
            <button class="btn">Çıkış</button>
        </div>
    </div>
    
    <div class="container">
        <div class="filters">
            <button class="filter-btn active">Tümü</button>
            <button class="filter-btn">Ödeme Bekleyen</button>
            <button class="filter-btn">Ödenen</button>
            <button class="filter-btn">Öncelikli</button>
        </div>
        
        <div class="cards-container">
            <!-- Siparişler burada dinamik olarak yüklenecek -->
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'https://masapp-backend.onrender.com/api';
        let isLoggedIn = false;
        let staffInfo = null;
        let orders = [];
        let realtimeConnection = null;

        // Login kontrolü
        function checkLogin() {
            const cashierStaff = sessionStorage.getItem('cashier_staff');
            if (cashierStaff) {
                staffInfo = JSON.parse(cashierStaff);
                isLoggedIn = true;
                document.querySelector('.header h1').textContent = `Kasa Paneli - ${staffInfo.name}`;
                loadOrders();
                connectRealtime();
            } else {
                showLoginForm();
            }
        }

        // Login formu göster
        function showLoginForm() {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div style="max-width: 400px; margin: 50px auto; padding: 2rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h2 style="text-align: center; margin-bottom: 2rem; color: #4caf50;">Kasa Paneli Girişi</h2>
                    <form id="loginForm">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Kullanıcı Adı:</label>
                            <input type="text" id="username" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Şifre:</label>
                            <input type="password" id="password" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        <button type="submit" style="width: 100%; padding: 0.75rem; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer;">
                            Giriş Yap
                        </button>
                    </form>
                    <div id="loginError" style="margin-top: 1rem; color: #e53935; text-align: center; display: none;"></div>
                    <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 4px; font-size: 0.9rem;">
                        <strong>Test Kullanıcıları:</strong><br>
                        Mutfak: portakal / 123456<br>
                        Kasa: armut / 123456
                    </div>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        // Login işlemi
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch(`${API_URL}/staff/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        subdomain: 'aksaray'
                    }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    if (result.data.role === 'cashier') {
                        staffInfo = result.data;
                        sessionStorage.setItem('cashier_staff', JSON.stringify(staffInfo));
                        isLoggedIn = true;
                        location.reload(); // Sayfayı yenile
                    } else {
                        errorDiv.textContent = 'Bu panele erişim yetkiniz yok. Sadece kasiyerler giriş yapabilir.';
                        errorDiv.style.display = 'block';
                    }
                } else {
                    errorDiv.textContent = result.message || 'Kullanıcı adı veya şifre hatalı';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Giriş yapılamadı. Lütfen tekrar deneyin.';
                errorDiv.style.display = 'block';
            }
        }

        // Siparişleri yükle
        async function loadOrders() {
            if (!isLoggedIn) return;

            try {
                // Önce restoran ID'sini bul
                const restaurantResponse = await fetch(`${API_URL}/restaurants`);
                const restaurantData = await restaurantResponse.json();
                const aksarayRestaurant = restaurantData.data?.find((r) => r.username === 'aksaray');
                
                if (!aksarayRestaurant) {
                    console.error('Aksaray restoranı bulunamadı');
                    return;
                }
                
                const response = await fetch(`${API_URL}/orders?restaurantId=${aksarayRestaurant.id}&status=pending`);
                const result = await response.json();

                if (result.success && result.data) {
                    orders = result.data;
                    renderOrders();
                }
            } catch (error) {
                console.error('Siparişler yüklenemedi:', error);
            }
        }

        // Siparişleri render et
        function renderOrders() {
            const container = document.querySelector('.cards-container');
            if (!container) return;

            if (orders.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">
                        <h3>Henüz sipariş yok</h3>
                        <p>Yeni siparişler geldiğinde burada görünecek.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="card ${order.priority === 'high' ? 'priority' : ''}">
                    <div class="card-header">
                        <div class="table-number">Masa ${order.tableNumber}</div>
                        ${order.priority === 'high' ? '<div class="priority-badge">Öncelikli</div>' : ''}
                    </div>
                    <div class="order-time ${getTimeAgo(order.createdAt) > 20 ? 'urgent' : ''}">${getTimeAgo(order.createdAt)} dk önce</div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <div class="item-name">
                                    ${item.name}
                                    ${item.notes ? `<div class="item-notes">${item.notes}</div>` : ''}
                                </div>
                                <div class="item-quantity">x${item.quantity}</div>
                                <div class="item-price">₺${item.price}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="card-footer">
                        <div class="total-amount">Toplam: ₺${order.totalAmount}</div>
                        <button class="btn btn-primary" onclick="processPayment('${order.id}')">
                            Ödeme Al
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Zaman hesaplama
        function getTimeAgo(timestamp) {
            const now = new Date();
            const orderTime = new Date(timestamp);
            const diffMs = now - orderTime;
            return Math.floor(diffMs / (1000 * 60));
        }

        // Ödeme işlemi
        async function processPayment(orderId) {
            try {
                const response = await fetch(`${API_URL}/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        status: 'completed',
                        paymentStatus: 'paid',
                        paidAt: new Date().toISOString()
                    }),
                });

                if (response.ok) {
                    loadOrders(); // Siparişleri yeniden yükle
                    alert('Ödeme başarıyla alındı!');
                } else {
                    alert('Ödeme işlemi başarısız!');
                }
            } catch (error) {
                console.error('Ödeme işlemi hatası:', error);
                alert('Ödeme işlemi sırasında hata oluştu!');
            }
        }

        // Real-time bağlantı
        function connectRealtime() {
            if (realtimeConnection) return;

            const baseUrl = API_URL.replace('/api', '');
            realtimeConnection = new EventSource(`${baseUrl}/api/events/orders`);

            realtimeConnection.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'new_order') {
                        console.log('Yeni sipariş geldi:', data);
                        loadOrders(); // Siparişleri yeniden yükle
                    }
                } catch (error) {
                    console.error('Real-time veri parse edilemedi:', error);
                }
            };

            realtimeConnection.onerror = () => {
                console.error('Real-time bağlantı hatası');
            };
        }

        // Çıkış fonksiyonu
        function logout() {
            sessionStorage.removeItem('cashier_staff');
            location.reload();
        }

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();

            // Çıkış butonu
            const logoutBtn = document.querySelector('.header button:last-child');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // Filtre butonları
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    // Filtreleme mantığı burada olabilir
                });
            });

            // Periyodik sipariş yenileme (30 saniye)
            setInterval(() => {
                if (isLoggedIn) {
                    loadOrders();
                }
            }, 30000);
        });
    </script>
</body>
</html>
