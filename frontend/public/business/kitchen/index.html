<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutfak Aray√ºz√º</title>
    <link rel="stylesheet" href="../../styles.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #e53935;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        .container {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            background-color: #e0e0e0;
            cursor: pointer;
        }
        .filter-btn.active {
            background-color: #e53935;
            color: white;
        }
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem;
        }
        .card.priority {
            border-left: 4px solid #e53935;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .table-number {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .order-time {
            font-size: 0.9rem;
            color: #757575;
        }
        .order-time.urgent {
            color: #e53935;
            font-weight: bold;
        }
        .order-items {
            margin: 1rem 0;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .item-name {
            flex: 1;
        }
        .item-quantity {
            margin: 0 1rem;
            font-weight: bold;
        }
        .item-notes {
            font-size: 0.8rem;
            color: #757575;
            margin-top: 0.25rem;
        }
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #e53935;
            color: white;
        }
        .btn-success {
            background-color: #4caf50;
            color: white;
        }
        .priority-badge {
            background-color: #e53935;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            .header h1 {
                font-size: 1.2rem;
            }
            .header div {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            .container {
                padding: 0.5rem;
            }
            .filters {
                justify-content: center;
                gap: 0.5rem;
            }
            .filter-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            .cards-container {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            .card {
                padding: 0.8rem;
            }
            .table-number {
                font-size: 1rem;
            }
            .order-item {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
            .item-quantity {
                margin: 0;
                align-self: flex-end;
            }
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
                width: 100%;
                margin-top: 0.5rem;
            }
            .card-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 0.8rem;
            }
            .header h1 {
                font-size: 1.1rem;
            }
            .filter-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
            }
            .card {
                padding: 0.6rem;
            }
            .table-number {
                font-size: 0.9rem;
            }
            .order-time {
                font-size: 0.8rem;
            }
            .item-name {
                font-size: 0.9rem;
            }
            .item-notes {
                font-size: 0.75rem;
            }
            .priority-badge {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
        }
        
        /* Tablet responsive styles */
        @media (min-width: 481px) and (max-width: 1024px) {
            .cards-container {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            .container {
                padding: 0.8rem;
            }
            .filter-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Mutfak Aray√ºz√º</h1>
        <div>
            <button class="btn" onclick="toggleDebug()">Debug</button>
            <button class="btn">Bildirimler</button>
            <button class="btn">√áƒ±kƒ±≈ü</button>
        </div>
    </div>
    
    <div class="container">
        <div class="filters">
            <button class="filter-btn active">T√ºm√º</button>
            <button class="filter-btn">Yeni</button>
            <button class="filter-btn">Hazƒ±rlanƒ±yor</button>
            <button class="filter-btn">Hazƒ±r</button>
            <button class="filter-btn">√ñncelikli</button>
        </div>
        
        <div class="cards-container">
            <!-- Sipari≈üler burada dinamik olarak y√ºklenecek -->
        </div>
        
        <!-- Debug Panel -->
        <div id="debugPanel" style="display: none; margin-top: 2rem; padding: 1rem; background: #f0f0f0; border-radius: 8px;">
            <h3 style="margin-top: 0; color: #e53935;">üêõ Debug Paneli</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <button class="btn" onclick="debugLogin()">Login Test</button>
                <button class="btn" onclick="debugAPI()">API Test</button>
                <button class="btn" onclick="debugOrders()">Sipari≈ü Test</button>
                <button class="btn" onclick="debugRealtime()">Real-time Test</button>
            </div>
            <div id="debugLog" style="background: #000; color: #0f0; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.8rem; max-height: 300px; overflow-y: auto;">
                Debug loglarƒ± burada g√∂r√ºnecek...<br>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'https://masapp-backend.onrender.com/api';
        let isLoggedIn = false;
        let staffInfo = null;
        let orders = [];
        let realtimeConnection = null;

        // Login kontrol√º
        function checkLogin() {
            const kitchenStaff = localStorage.getItem('kitchen_staff');
            if (kitchenStaff) {
                staffInfo = JSON.parse(kitchenStaff);
                isLoggedIn = true;
                document.querySelector('.header h1').textContent = `Mutfak Aray√ºz√º - ${staffInfo.name}`;
                loadOrders();
                connectRealtime();
            } else {
                showLoginForm();
            }
        }

        // Login formu g√∂ster
        function showLoginForm() {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div style="max-width: 400px; margin: 50px auto; padding: 2rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h2 style="text-align: center; margin-bottom: 2rem; color: #e53935;">Mutfak Paneli Giri≈üi</h2>
                    <form id="loginForm">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Kullanƒ±cƒ± Adƒ±:</label>
                            <input type="text" id="username" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">≈ûifre:</label>
                            <input type="password" id="password" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        <button type="submit" style="width: 100%; padding: 0.75rem; background: #e53935; color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer;">
                            Giri≈ü Yap
                        </button>
                    </form>
                    <div id="loginError" style="margin-top: 1rem; color: #e53935; text-align: center; display: none;"></div>
                    <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 4px; font-size: 0.9rem;">
                        <strong>Test Kullanƒ±cƒ±larƒ±:</strong><br>
                        Mutfak: portakal / 123456<br>
                        Kasa: armut / 123456
                    </div>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        // Login i≈ülemi
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch(`${API_URL}/staff/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        subdomain: 'aksaray'
                    }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    if (result.data.role === 'chef') {
                        staffInfo = result.data;
                        localStorage.setItem('kitchen_staff', JSON.stringify(staffInfo));
                        isLoggedIn = true;
                        location.reload(); // Sayfayƒ± yenile
                    } else {
                        errorDiv.textContent = 'Bu panele eri≈üim yetkiniz yok. Sadece mutfak personeli giri≈ü yapabilir.';
                        errorDiv.style.display = 'block';
                    }
                } else {
                    errorDiv.textContent = result.message || 'Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Giri≈ü yapƒ±lamadƒ±. L√ºtfen tekrar deneyin.';
                errorDiv.style.display = 'block';
            }
        }

        // Sipari≈üleri y√ºkle
        async function loadOrders() {
            if (!isLoggedIn) return;
            
            try {
                // √ñnce restoran ID'sini bul
                const restaurantResponse = await fetch(`${API_URL}/restaurants`);
                const restaurantData = await restaurantResponse.json();
                const aksarayRestaurant = restaurantData.data?.find((r) => r.username === 'aksaray');
                
                if (!aksarayRestaurant) {
                    console.error('Aksaray restoranƒ± bulunamadƒ±');
                    return;
                }
                
                const response = await fetch(`${API_URL}/orders?restaurantId=${aksarayRestaurant.id}&status=pending`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    orders = result.data;
                    renderOrders();
                }
            } catch (error) {
                console.error('Sipari≈üler y√ºklenemedi:', error);
            }
        }

        // Sipari≈üleri render et
        function renderOrders() {
            const container = document.querySelector('.cards-container');
            if (!container) return;

            if (orders.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #666;">
                        <h3>Hen√ºz sipari≈ü yok</h3>
                        <p>Yeni sipari≈üler geldiƒüinde burada g√∂r√ºnecek.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="card ${order.priority === 'high' ? 'priority' : ''}">
                    <div class="card-header">
                        <div class="table-number">Masa ${order.tableNumber}</div>
                        ${order.priority === 'high' ? '<div class="priority-badge">√ñncelikli</div>' : ''}
                    </div>
                    <div class="order-time ${getTimeAgo(order.createdAt) > 20 ? 'urgent' : ''}">${getTimeAgo(order.createdAt)} dk √∂nce</div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <div class="item-name">
                                    ${item.name}
                                    ${item.notes ? `<div class="item-notes">${item.notes}</div>` : ''}
                                </div>
                                <div class="item-quantity">x${item.quantity}</div>
                                <button class="btn btn-primary" onclick="updateItemStatus('${order.id}', '${item.id}')">
                                    Hazƒ±rla
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="card-footer">
                        <div>Toplam: ‚Ç∫${order.totalAmount}</div>
                    </div>
                </div>
            `).join('');
        }

        // Zaman hesaplama
        function getTimeAgo(timestamp) {
            const now = new Date();
            const orderTime = new Date(timestamp);
            const diffMs = now - orderTime;
            return Math.floor(diffMs / (1000 * 60));
        }

        // Item durumu g√ºncelle
        async function updateItemStatus(orderId, itemId) {
            try {
                const response = await fetch(`${API_URL}/orders/${orderId}/items/${itemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: 'ready' }),
                });

                if (response.ok) {
                    loadOrders(); // Sipari≈üleri yeniden y√ºkle
                }
            } catch (error) {
                console.error('Item durumu g√ºncellenemedi:', error);
            }
        }

        // Real-time baƒülantƒ±
        function connectRealtime() {
            if (realtimeConnection) return;

            const baseUrl = API_URL.replace('/api', '');
            realtimeConnection = new EventSource(`${baseUrl}/api/events/orders`);

            realtimeConnection.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'new_order') {
                        console.log('Yeni sipari≈ü geldi:', data);
                        loadOrders(); // Sipari≈üleri yeniden y√ºkle
                    }
                } catch (error) {
                    console.error('Real-time veri parse edilemedi:', error);
                }
            };

            realtimeConnection.onerror = () => {
                console.error('Real-time baƒülantƒ± hatasƒ±');
            };
        }

        // √áƒ±kƒ±≈ü fonksiyonu
        function logout() {
            localStorage.removeItem('kitchen_staff');
            location.reload();
        }

        // Debug fonksiyonlarƒ±
        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function debugLog(message) {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`üêõ DEBUG: ${message}`);
        }

        async function debugLogin() {
            debugLog('=== LOGIN TEST BA≈ûLADI ===');
            debugLog(`API URL: ${API_URL}`);
            debugLog(`LocalStorage kitchen_staff: ${localStorage.getItem('kitchen_staff')}`);
            debugLog(`isLoggedIn: ${isLoggedIn}`);
            debugLog(`staffInfo: ${JSON.stringify(staffInfo)}`);
            
            try {
                const response = await fetch(`${API_URL}/staff/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'portakal', password: '123456', subdomain: 'aksaray' }),
                });
                
                debugLog(`Login Response Status: ${response.status}`);
                const result = await response.json();
                debugLog(`Login Response: ${JSON.stringify(result)}`);
                
                if (response.ok && result.success) {
                    debugLog('‚úÖ Login ba≈üarƒ±lƒ±!');
                } else {
                    debugLog(`‚ùå Login ba≈üarƒ±sƒ±z: ${result.message}`);
                }
            } catch (error) {
                debugLog(`‚ùå Login hatasƒ±: ${error.message}`);
            }
        }

        async function debugAPI() {
            debugLog('=== API TEST BA≈ûLADI ===');
            debugLog(`API URL: ${API_URL}`);
            
            try {
                // Health check
                const healthResponse = await fetch(`${API_URL.replace('/api', '')}/health`);
                debugLog(`Health Check Status: ${healthResponse.status}`);
                const healthData = await healthResponse.json();
                debugLog(`Health Data: ${JSON.stringify(healthData)}`);
                
                // Restaurants endpoint
                const restaurantsResponse = await fetch(`${API_URL}/restaurants`);
                debugLog(`Restaurants Status: ${restaurantsResponse.status}`);
                const restaurantsData = await restaurantsResponse.json();
                debugLog(`Restaurants Data: ${JSON.stringify(restaurantsData)}`);
                
            } catch (error) {
                debugLog(`‚ùå API hatasƒ±: ${error.message}`);
            }
        }

        async function debugOrders() {
            debugLog('=== Sƒ∞PARƒ∞≈û TEST BA≈ûLADI ===');
            debugLog(`API URL: ${API_URL}`);
            debugLog(`isLoggedIn: ${isLoggedIn}`);
            
            try {
                // √ñnce restoran ID'sini bul
                debugLog('Restoran ID\'si bulunuyor...');
                const restaurantResponse = await fetch(`${API_URL}/restaurants`);
                const restaurantData = await restaurantResponse.json();
                const aksarayRestaurant = restaurantData.data?.find((r) => r.username === 'aksaray');
                
                if (!aksarayRestaurant) {
                    debugLog('‚ùå Aksaray restoranƒ± bulunamadƒ±!');
                    return;
                }
                
                debugLog(`‚úÖ Aksaray restoran ID: ${aksarayRestaurant.id}`);
                
                const response = await fetch(`${API_URL}/orders?restaurantId=${aksarayRestaurant.id}&status=pending`);
                debugLog(`Orders Response Status: ${response.status}`);
                debugLog(`Orders Response Headers: ${JSON.stringify([...response.headers.entries()])}`);
                
                const result = await response.json();
                debugLog(`Orders Response: ${JSON.stringify(result)}`);
                
                if (result.success && result.data) {
                    debugLog(`‚úÖ ${result.data.length} sipari≈ü bulundu`);
                    result.data.forEach((order, index) => {
                        debugLog(`Sipari≈ü ${index + 1}: Masa ${order.tableNumber}, ${order.items?.length || 0} √ºr√ºn, ‚Ç∫${order.totalAmount}`);
                    });
                } else {
                    debugLog(`‚ùå Sipari≈ü verisi alƒ±namadƒ±: ${result.message}`);
                }
            } catch (error) {
                debugLog(`‚ùå Sipari≈ü hatasƒ±: ${error.message}`);
            }
        }

        async function debugRealtime() {
            debugLog('=== REAL-TIME TEST BA≈ûLADI ===');
            debugLog(`Realtime Connection: ${realtimeConnection ? 'Mevcut' : 'Yok'}`);
            
            if (realtimeConnection) {
                debugLog(`Realtime State: ${realtimeConnection.readyState}`);
                debugLog(`Realtime URL: ${realtimeConnection.url}`);
            }
            
            try {
                const baseUrl = API_URL.replace('/api', '');
                const testConnection = new EventSource(`${baseUrl}/api/events/orders`);
                
                testConnection.onopen = () => {
                    debugLog('‚úÖ Real-time baƒülantƒ± a√ßƒ±ldƒ±');
                };
                
                testConnection.onmessage = (event) => {
                    debugLog(`üì® Real-time mesaj: ${event.data}`);
                };
                
                testConnection.onerror = (error) => {
                    debugLog(`‚ùå Real-time hata: ${error}`);
                };
                
                setTimeout(() => {
                    testConnection.close();
                    debugLog('üîí Test baƒülantƒ±sƒ± kapatƒ±ldƒ±');
                }, 5000);
                
            } catch (error) {
                debugLog(`‚ùå Real-time test hatasƒ±: ${error.message}`);
            }
        }

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();

            // √áƒ±kƒ±≈ü butonu
            const logoutBtn = document.querySelector('.header button:last-child');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // Filtre butonlarƒ±
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    // Filtreleme mantƒ±ƒüƒ± burada olabilir
                });
            });

            // Periyodik sipari≈ü yenileme (30 saniye)
            setInterval(() => {
                if (isLoggedIn) {
                    loadOrders();
                }
            }, 30000);
        });
    </script>
</body>
</html>

