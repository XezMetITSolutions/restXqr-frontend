<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutfak Paneli - Aksaray</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-icon {
            width: 48px;
            height: 48px;
            background: #28a745;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header-title h1 {
            color: #333;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }

        .header-title p {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }

        .header-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-yellow {
            background: #ffc107;
            color: #212529;
        }

        .btn-yellow:hover {
            background: #e0a800;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .dropdown {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem 2rem;
        }

        .content-box {
            background: #fff8dc;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .search-bar {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            background: white;
        }

        .search-bar:focus {
            outline: none;
            border-color: #28a745;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-btn {
            padding: 0.75rem 1.5rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .filter-btn:hover {
            background: #f0f0f0;
        }

        .filter-btn.active:hover {
            background: #218838;
        }

        .orders-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .order-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: grid;
            grid-template-columns: 2fr 2fr 1fr;
            gap: 2rem;
        }

        .order-card-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .order-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .room-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .order-status {
            background: #fff3cd;
            color: #856404;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .order-date {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .section-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .order-item {
            color: #666;
            font-size: 0.95rem;
            padding: 0.25rem 0;
        }

        .order-info {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .info-label {
            color: #666;
        }

        .info-value {
            font-weight: 600;
            color: #333;
        }

        .info-value.amount {
            color: #28a745;
            font-size: 1.1rem;
        }

        .payment-status {
            background: #fff3cd;
            color: #856404;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .btn-start {
            background: #ff8c00;
            color: white;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
        }

        .btn-start:hover {
            background: #e67e00;
        }

        .btn-details {
            background: #f0f0f0;
            color: #333;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
        }

        .btn-details:hover {
            background: #e0e0e0;
        }

        .no-orders {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }

        .no-orders h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 1024px) {
            .order-card {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .header-left {
                width: 100%;
                justify-content: center;
            }

            .header-buttons {
                width: 100%;
                justify-content: space-between;
            }

            .main-container {
                padding: 0 1rem 1rem;
            }

            .content-box {
                padding: 1rem;
            }

            .filter-btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }

            .filters {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="header-icon">üë®‚Äçüç≥</div>
            <div class="header-title">
                <h1>Mutfak Paneli</h1>
                <p>Oda servisi sipari≈ülerini ve men√º √ºr√ºnlerini y√∂netin</p>
            </div>
        </div>
        <div class="header-buttons">
            <button class="btn btn-yellow" onclick="showMenuManagement()">+ Men√º Y√∂netimi</button>
            <div class="dropdown" onclick="toggleLanguage()">
                TR T√ºrk√ße ‚Üì
            </div>
            <button class="btn btn-secondary" onclick="logout()">üö™ √áƒ±kƒ±≈ü</button>
        </div>
    </div>

    <div class="main-container">
        <div class="content-box">
            <input type="text" class="search-bar" placeholder="üîç Oda numarasƒ± veya √ºr√ºn ara..." id="searchInput" onkeyup="filterOrders()">

            <div class="filters">
                <button class="filter-btn active" onclick="setFilter('all')">T√ºm√º (0)</button>
                <button class="filter-btn" onclick="setFilter('pending')">Bekleyen (0)</button>
                <button class="filter-btn" onclick="setFilter('preparing')">Hazƒ±rlanan (0)</button>
                <button class="filter-btn" onclick="setFilter('ready')">Teslim Edilen (0)</button>
                <button class="filter-btn" onclick="setFilter('cancelled')">ƒ∞ptal Edilen (0)</button>
            </div>

            <div class="orders-container" id="ordersContainer">
                <div class="no-orders">
                    <h3>üë®‚Äçüç≥ Hen√ºz sipari≈ü yok</h3>
                    <p>Yeni sipari≈üler geldiƒüinde burada g√∂r√ºnecek.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'https://masapp-backend.onrender.com/api';
        let isLoggedIn = false;
        let staffInfo = null;
        let orders = [];
        let realtimeConnection = null;
        let currentFilter = 'all';

        // Login kontrol√º
        function checkLogin() {
            console.log('üîç Mutfak login kontrol√º yapƒ±lƒ±yor...');
            const kitchenStaff = localStorage.getItem('kitchen_staff');
            console.log('üîç LocalStorage kitchen_staff:', kitchenStaff);
            
            if (kitchenStaff) {
                staffInfo = JSON.parse(kitchenStaff);
                isLoggedIn = true;
                console.log('‚úÖ Login ba≈üarƒ±lƒ±, sipari≈üler y√ºkleniyor...');
                loadOrders();
                connectRealtime();
            } else {
                console.log('‚ùå Login yok, login formu g√∂steriliyor...');
                showLoginForm();
            }
        }

        // Login formu g√∂ster
        function showLoginForm() {
            const container = document.querySelector('.main-container');
            container.innerHTML = `
                <div style="max-width: 400px; margin: 50px auto; padding: 2rem; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                    <h2 style="text-align: center; margin-bottom: 2rem; color: #28a745;">üë®‚Äçüç≥ Mutfak Paneli Giri≈üi</h2>
                    <form id="loginForm">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Kullanƒ±cƒ± Adƒ±:</label>
                            <input type="text" id="username" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">≈ûifre:</label>
                            <input type="password" id="password" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        </div>
                        <button type="submit" style="width: 100%; padding: 0.75rem; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600;">
                            üë®‚Äçüç≥ Mutfak Olarak Giri≈ü Yap
                        </button>
                    </form>
                    <div id="loginError" style="margin-top: 1rem; color: #dc3545; text-align: center; display: none;"></div>
                    <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem;">
                        <strong>Test Kullanƒ±cƒ±larƒ±:</strong><br>
                        Mutfak: portakal / 123456<br>
                        Garson: elma / 123456<br>
                        Kasa: armut / 123456
                    </div>
                </div>
            `;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        // Login i≈ülemi
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch(`${API_URL}/staff/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, password: password, subdomain: 'aksaray' }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    if (result.data.role === 'chef') {
                        staffInfo = result.data;
                        localStorage.setItem('kitchen_staff', JSON.stringify(staffInfo));
                        isLoggedIn = true;
                        location.reload();
                    } else {
                        errorDiv.textContent = 'Bu panele eri≈üim yetkiniz yok. Sadece mutfak personeli giri≈ü yapabilir.';
                        errorDiv.style.display = 'block';
                    }
                } else {
                    errorDiv.textContent = result.message || 'Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Giri≈ü yapƒ±lamadƒ±. L√ºtfen tekrar deneyin.';
                errorDiv.style.display = 'block';
            }
        }

        // Sipari≈üleri y√ºkle
        async function loadOrders() {
            if (!isLoggedIn) {
                console.log('‚ùå Login yok, sipari≈üler y√ºklenmiyor');
                return;
            }
            
            console.log('üîÑ Sipari≈üler y√ºkleniyor...');
            
            try {
                const restaurantResponse = await fetch(`${API_URL}/restaurants`);
                const restaurantData = await restaurantResponse.json();
                const aksarayRestaurant = restaurantData.data?.find((r) => r.username === 'aksaray');
                
                if (!aksarayRestaurant) {
                    console.error('‚ùå Aksaray restoranƒ± bulunamadƒ±');
                    return;
                }
                
                console.log('‚úÖ Restoran bulundu:', aksarayRestaurant.id);
                
                const response = await fetch(`${API_URL}/orders?restaurantId=${aksarayRestaurant.id}`);
                const result = await response.json();
                
                console.log('üìã API yanƒ±tƒ±:', result);
                
                if (result.success && result.data) {
                    orders = result.data;
                    console.log(`‚úÖ ${orders.length} sipari≈ü y√ºklendi, render ediliyor...`);
                    updateFilterCounts();
                    renderOrders();
                } else {
                    console.log('‚ùå API ba≈üarƒ±sƒ±z:', result);
                }
            } catch (error) {
                console.error('‚ùå Sipari≈üler y√ºklenemedi:', error);
            }
        }

        // Filtre sayƒ±larƒ±nƒ± g√ºncelle
        function updateFilterCounts() {
            const allCount = orders.length;
            const pendingCount = orders.filter(o => o.status === 'pending').length;
            const preparingCount = orders.filter(o => o.status === 'preparing').length;
            const readyCount = orders.filter(o => o.status === 'ready').length;
            const cancelledCount = orders.filter(o => o.status === 'cancelled').length;

            document.querySelectorAll('.filter-btn')[0].textContent = `T√ºm√º (${allCount})`;
            document.querySelectorAll('.filter-btn')[1].textContent = `Bekleyen (${pendingCount})`;
            document.querySelectorAll('.filter-btn')[2].textContent = `Hazƒ±rlanan (${preparingCount})`;
            document.querySelectorAll('.filter-btn')[3].textContent = `Teslim Edilen (${readyCount})`;
            document.querySelectorAll('.filter-btn')[4].textContent = `ƒ∞ptal Edilen (${cancelledCount})`;
        }

        // Filtre butonu i≈ülemi
        function setFilter(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderOrders();
        }

        // Sipari≈üleri filtrele
        function filterOrders() {
            renderOrders();
        }

        // Sipari≈üleri render et
        function renderOrders() {
            const container = document.getElementById('ordersContainer');
            const searchValue = document.getElementById('searchInput')?.value.toLowerCase() || '';
            
            let filteredOrders = orders;
            
            // Durum filtresi
            if (currentFilter !== 'all') {
                filteredOrders = filteredOrders.filter(o => o.status === currentFilter);
            }
            
            // Arama filtresi
            if (searchValue) {
                filteredOrders = filteredOrders.filter(o => 
                    o.tableNumber.toString().includes(searchValue) ||
                    o.items.some(item => item.name.toLowerCase().includes(searchValue))
                );
            }
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="no-orders">
                        <h3>üë®‚Äçüç≥ Hen√ºz sipari≈ü yok</h3>
                        <p>Yeni sipari≈üler geldiƒüinde burada g√∂r√ºnecek.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredOrders.map(order => {
                const statusText = {
                    'pending': 'BEKLEMEDE',
                    'preparing': 'HAZIRLANIYOR',
                    'ready': 'HAZIR',
                    'cancelled': 'ƒ∞PTAL EDƒ∞LDƒ∞'
                };
                
                const statusBadgeColor = {
                    'pending': '#fff3cd',
                    'preparing': '#d4edda',
                    'ready': '#cce5ff',
                    'cancelled': '#f8d7da'
                };
                
                const statusTextColor = {
                    'pending': '#856404',
                    'preparing': '#155724',
                    'ready': '#004085',
                    'cancelled': '#721c24'
                };
                
                return `
                    <div class="order-card">
                        <div class="order-card-section">
                            <div class="order-header-top">
                                <div>
                                    <div class="room-number">Oda ${order.tableNumber || order.roomNumber || 'N/A'}</div>
                                    <div class="order-date">${formatDate(order.createdAt)}</div>
                                </div>
                                <div class="order-status" style="background: ${statusBadgeColor[order.status]}; color: ${statusTextColor[order.status]}">
                                    ‚è±Ô∏è ${statusText[order.status]}
                                </div>
                            </div>
                            <div>
                                <div class="section-title">Sipari≈ü Detaylarƒ±:</div>
                                ${order.items.map(item => `
                                    <div class="order-item">${item.quantity}x ${item.name}</div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="order-card-section">
                            <div class="section-title">Sipari≈ü Bilgileri:</div>
                            <div class="order-info">
                                <div class="info-row">
                                    <span class="info-label">Toplam Tutar:</span>
                                    <span class="info-value amount">${parseFloat(order.totalAmount || 0).toFixed(2)}‚Ç∫</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Tahmini S√ºre:</span>
                                    <span class="info-value">${calculateEstimatedTime(order.createdAt)} dk</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">√ñdeme Durumu:</span>
                                    <span class="payment-status">${order.paymentStatus === 'paid' ? '√ñDENDƒ∞' : 'BEKLEMEDE'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="order-card-section">
                            <div class="action-buttons">
                                ${order.status === 'pending' ? `
                                    <button class="btn-start" onclick="startPreparation('${order.id}')">
                                        ‚ñ∂ Hazƒ±rlƒ±ƒüa Ba≈üla
                                    </button>
                                ` : order.status === 'preparing' ? `
                                    <button class="btn-success" onclick="markAsReady('${order.id}')" style="padding: 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        ‚úÖ Hazƒ±rla
                                    </button>
                                ` : ''}
                                <button class="btn-details" onclick="showDetails('${order.id}')">
                                    üëÅ Detaylar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Tarih formatƒ±
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;
        }

        // Tahmini s√ºre hesapla
        function calculateEstimatedTime(createdAt) {
            const now = new Date();
            const orderTime = new Date(createdAt);
            const diffMs = now - orderTime;
            return Math.floor(diffMs / (1000 * 60));
        }

        // Hazƒ±rlƒ±ƒüa ba≈üla
        async function startPreparation(orderId) {
            try {
                const response = await fetch(`${API_URL}/orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'preparing' }),
                });
                if (response.ok) {
                    loadOrders();
                }
            } catch (error) { 
                console.error('Sipari≈ü durumu g√ºncellenemedi:', error); 
            }
        }

        // Hazƒ±r olarak i≈üaretle
        async function markAsReady(orderId) {
            try {
                const response = await fetch(`${API_URL}/orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'ready' }),
                });
                if (response.ok) {
                    loadOrders();
                }
            } catch (error) { 
                console.error('Sipari≈ü durumu g√ºncellenemedi:', error); 
            }
        }

        // Detaylarƒ± g√∂ster
        function showDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                const details = `
Sipari≈ü Detaylarƒ±:
-------------------
Oda: ${order.tableNumber}
Durum: ${order.status}
Toplam: ${parseFloat(order.totalAmount || 0).toFixed(2)}‚Ç∫
Tarih: ${formatDate(order.createdAt)}

√úr√ºnler:
${order.items.map(item => `  - ${item.quantity}x ${item.name} - ${parseFloat(item.price || 0).toFixed(2)}‚Ç∫`).join('\n')}
                `;
                alert(details);
            }
        }

        // Men√º y√∂netimi
        function showMenuManagement() {
            alert('Men√º y√∂netimi √∂zelliƒüi yakƒ±nda gelecek!');
        }

        // Dil deƒüi≈ütir
        function toggleLanguage() {
            alert('Dil se√ßenekleri yakƒ±nda eklenecek!');
        }

        // Real-time baƒülantƒ± kur
        function connectRealtime() {
            if (realtimeConnection) return;
            const baseUrl = API_URL.replace('/api', '');
            realtimeConnection = new EventSource(`${baseUrl}/api/events/orders`);
            realtimeConnection.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'new_order' || data.type === 'order_status_updated') {
                        console.log('Yeni sipari≈ü veya durum g√ºncellemesi geldi:', data);
                        loadOrders();
                    }
                } catch (error) { 
                    console.error('Real-time veri parse edilemedi:', error); 
                }
            };
            realtimeConnection.onerror = () => {
                console.error('Real-time baƒülantƒ± hatasƒ±');
            };
        }

        // √áƒ±kƒ±≈ü fonksiyonu
        function logout() {
            if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinize emin misiniz?')) {
                localStorage.removeItem('kitchen_staff');
                location.reload();
            }
        }

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üë®‚Äçüç≥ Mutfak paneli y√ºklendi');
            checkLogin();

            // Her 30 saniyede bir sipari≈üleri yenile
            setInterval(loadOrders, 30000);
        });
    </script>
</body>
</html>